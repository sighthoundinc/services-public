# On-Demand Analytics REST API Sample

## Summary

This sample implements a REST API-based analytics system, allowing monitoring of an RTSP stream and retrieving the most recent image with associated analytics, as well as providing an inline image for analytics.

## Implementation

This sample is backed by two separate pipelines, executing within the same process:

1. **RTSP Monitoring Pipeline**: Responsible for monitoring an RTSP stream, outputting its results to a shared storage volume, and managing the lifecycle of the output. The output is generated and managed using an extension module.

2. **Folder Watch Pipeline**: A standard pipeline that monitors a folder for changes.

The REST API is implemented using the Flask module, providing a front-end interface for the system. Upon a request for analytics, the API locates the most recent file generated by the live pipeline and serves JSON containing the image and relevant analytics. Another API variant serves an `image/jpg`, which is useful for debugging.

## Special Instructions for Jetson Devices

When deploying on Jetson devices, additional configuration is required:

1. Set the `SIO_DOCKER_TAG_VARIANT` environment variable to the appropriate value:
   ```bash
   export SIO_DOCKER_TAG_VARIANT=-r32.7.3-arm64v8
   ```
2. Configure Docker to use the NVIDIA runtime:
   ```bash
   export SIO_DOCKER_RUNTIME=nvidia
   ```
3. Modify `docker-compose` to add the network:
   ```yaml
   networks:
     sh-device-ui_sh-ui-net:
       external: true
   ```
4. Add the following to the analytics service in `docker-compose`:
   ```yaml
   networks:
     sh-device-ui_sh-ui-net:
       aliases:
         - sioanalytics
   ```
5. Update the pipeline configuration to use the camera URL:
   ```json
   "VIDEO_IN": "rtsp://sh-ui-backend:8555/live"
   ```
   To automate this step, use a `sed` command to replace the `VIDEO_IN` URL in `pipelines.json`:
   ```bash
   sed -i 's|"VIDEO_IN".*:.*"rtsp://.*"|"VIDEO_IN": "rtsp://sh-ui-backend:8555/live"|' config/analytics/pipelines.json
   ```

## Testing the API

After everything is running, you can test the API by running:
```bash
curl http://<camera_ip or localhost>:8080/alpr/v1.0/locations/100
```
This will return an output similar to the following:
```json
{
  "location": {
    "id": 100
  },
  "streamDetail": [
    {
      "image": [
        {
          "id": 1,
          "imageData": "",
          "licensePlate": {
            "lpRegion": "unknown",
            "lpString": "unknown",
            "lpnConfidence": 0
          },
          "vehicle": {
            "color": "unknown",
            "make": "unknown",
            "model": "unknown"
          }
        }
      ],
      "preferredImage": 1,
      "stream": {
        "id": 1
      }
    }
  ]
}
```

## Client

A sample client is implemented in `SIOOnDemandAnalytics/clients/OnDemandTest.py`. You can run the client using:
```bash
python3 ./clients/OnDemandTest.py [-i inputImage] [-o outputFolder]
```

## OS Compatibility

The `SIO_DOCKER_TAG_VARIANT` environment variable in `docker-compose` controls the flavor of the SIO analytics container image. For Jetson-based systems, it should be set based on your OS version:

- `-r32.4.3-arm64v8` (built for hardware running Jetpack 4.4)
- `-r32.7.3-arm64v8` (built for hardware running Jetpack 4.6)
- `-r35.3.1-arm64v8` (work in progress, built for hardware running Jetpack 5.1)

For x86-based systems, use:

- `-amd64`

## Sample Pipeline Configuration

Below is an example of the RTSP section of the `pipelines.json` configuration:

```json
{
    "rtsp": {
        "pipeline": "./share/pipelines/VehicleAnalytics/VehicleAnalyticsRTSP.yaml",
        "restartPolicy": "restart",
        "parameters": {
            "VIDEO_IN": "rtsp://sh-ui-backend:8555/live",
            "boxFilterConfig": "/config/analytics/boxFilter.json",
            "detectionModel": "gen7es",
            "lptModel": "gen7es",
            "lptFilter": "['eu', 'us']",
            "lptMinConfidence": "0.7",
            "sourceId": "rtsp-stream-1",
            "lptPreferAccuracyToSpeed": "false",
            "fpsLimit": "2",
            "updateOnlyOnChange": "false",
            "splitMakeModel": "true",
            "extensionModules": "/config/analytics/extension.py",
            "extensionConfigurations": "/config/analytics/extensionConfig.json"
        }
    }
}
```

